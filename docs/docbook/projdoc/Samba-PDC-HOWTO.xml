<chapter id="samba-pdc">

<chapterinfo>
	&author.jht;
	&author.jerry;
	<author>
		<firstname>David</firstname><surname>Bannon</surname>
		<affiliation>
			<orgname>Samba Team</orgname>
			<address><email>dbannon@samba.org</email></address>
		</affiliation>
	</author>
</chapterinfo>

<title>Domain Control</title>

<formalpara><title><emphasis>The Essence of Learning:</emphasis></title>
<para>
There are many who approach MS Windows networking with incredible misconceptions.
That's OK, because it give the rest of us plenty of opportunity to be of assistance.
Those who really want help would be well advised to become familiar with information
that is already available.
</para>
</formalpara>

<para>
The reader is advised NOT to tackle this section without having first understood
and mastered some basics. MS Windows networking is not particularly forgiving of
misconfiguration. Users of MS Windows networking are likely to complain bitterly
of persistent niggles that may be caused by broken network or system configuration.
To a great many people however, MS Windows networking starts with a domain controller
that in some magical way is expected to solve all ills.
</para>

<para>
From the Samba mailing list one can readilly identify many common networking issues.
If you are not clear on the following subjects, then it will do much good to read the 
sections of this HOWTO that deal with it. These are the most common causes of MS Windows
networking problems:
</para>

<simplelist>
	<member>Basic TCP/IP configuration</member>
	<member>NetBIOS name resolution</member>
	<member>Authentication configuration</member>
	<member>User and Group configuration</member>
	<member>Basic File and Directory Permission Control in Unix/Linux</member>
	<member>Understanding of how MS Windows clients interoperate in a network
		environment</member>
</simplelist>

<para>
Do not be put off, on the surface of it MS Windows networking seems so simple that any fool
can do it. In fact, it is not a good idea to set up an MS Windows network with
inadequate training and preparation. But let's get our first indelible principle out of the
way: <emphasis>It is perfectly OK to make mistakes!</emphasis> In the right place and at
the right time, mistakes are the essence of learning. It is <emphasis>very much</emphasis>
not ok to make mistakes that cause loss of productivity and impose an avoidable financial
burden on an organisation.
</para>

<para>
Where is the right place to make mistakes? Only out of harms' way! If you are going to
make mistakes, then please do this on a test network, away from users and in such a way as
to not inflict pain on others. Do your learning on a test network.
</para>

<sect1>
<title>Features and Benefits</title>

<para>
<emphasis>What is the key benefit of Microsoft Domain security?</emphasis>
</para>

<para>
In a word, <emphasis>Single Sign On</emphasis>, or SSO for short. This to many is the holy
grail of MS Windows NT and beyond networking. SSO allows users in a well designed network
to log onto any workstation that is a member of the domain that their user account is in
(or in a domain that has an appropriate trust relationship with the domain they are visiting)
and they will be able to log onto the network and access resources (shares, files, and printers)
as if they are sitting at their home (personal) workstation. This is a feature of the Domain
security protocols.
</para>

<para>
The benefits of Domain security are fully available to those sites that deploy a Samba PDC.
</para>

<note><para>
Network clients of an MS Windows Domain security environment must be Domain members to be
able to gain access to the advanced features provided. Domain membership involves more than just
setting the workgroup name to the Domain name. It requires the creation of a Domain trust account
for the workstation (called a machine account). Please refer to the chapter on Domain Membership
for more information.
</para></note>

<para>
The following functionalities are new to the Samba-3 release:
</para>

<itemizedlist>
	<listitem><para>
	Windows NT4 domain trusts
	</para></listitem>
	
	<listitem><para>
	Adding users via the User Manager for Domains. This can be done on any MS Windows
	client using the Nexus toolkit that is available from Microsoft's web site.
	At some later date Samba-3 may get support for the use of the Microsoft Management
	Console for user management.
	</para></listitem>

	<listitem><para>
	Introduces replaceable and multiple user account (authentication)
	back ends. In the case where the back end is placed in an LDAP database
	Samba-3 confers the benefits of a back end that can be distributed, replicated,
	and highly scalable.
	</para></listitem>

	<listitem><para>
	Implements full Unicode support. This simplifies cross locale internationalisation
	support. It also opens up the use of protocols that samba-2.2.x had but could not use due
	to the need to fully support Unicode.
	</para></listitem>
</itemizedlist>

<para>
The following functionalities are NOT provided by Samba-3:
</para>

<itemizedlist>
	<listitem><para>
	SAM replication with Windows NT4 Domain Controllers
	(i.e. a Samba PDC and a Windows NT BDC or vice versa) 
	</para></listitem>
	
	<listitem><para>
	Acting as a Windows 2000 Domain Controller (i.e. Kerberos and 
	Active Directory) - In point of fact, Samba-3 DOES have some
	Active Directory Domain Control ability that is at this time
	purely experimental <emphasis>AND</emphasis> that is certain
	to change as it becomes a fully supported feature some time
	during the samba-3 (or later) life cycle.
	</para></listitem>
</itemizedlist>

<para>
Windows 9x / Me / XP Home clients are not true members of a domain for reasons outlined
in this chapter.  The protocol for support of Windows 9x / Me style network (domain) logons
is completely different from NT4 / Win2k type domain logons and has been officially supported
for some time. These clients use the old LanMan Network Logon facilities that are supported
in Samba since approximately the samba-1.9.15 series.
</para>

<para>
Samba-3 has an implementation of group mapping between Windows NT groups
and Unix groups (this is really quite complicated to explain in a short space) this is 
discussed more fully in a chapter dedicated to this topic..
</para>

<para>
A Samba-3, like an MS Windows NT4 PDC or a Windows 200x Active Directory, needs to store
user and machine trust account information in a suitable backend data store. With Samba-3
there can be multiple back-ends for this including:
</para>

<!-- FIXME: Doesn't this belong in passdb.xml ? -->

<itemizedlist>
	<listitem><para>
	<emphasis>smbpasswd</emphasis> - the plain ascii file stored used by
	earlier versions of Samba. This file configuration option requires
	a Unix/Linux system account for EVERY entry (ie: both for user and for
	machine accounts). This file will be located in the <emphasis>private</emphasis>
	directory (default is /usr/local/samba/lib/private or on linux /etc/samba).
	</para></listitem>

	<listitem><para>
	<emphasis>tdbsam</emphasis> - a binary database backend that will be
	stored in the <emphasis>private</emphasis> directory in a file called
	<emphasis>passwd.tdb</emphasis>. The key benefit of this binary format
	file is that it can store binary objects that can not be accomodated
	in the traditional plain text smbpasswd file. These permit the extended
	account controls that MS Windows NT4 and later also have.
	</para></listitem>

	<listitem><para>
	<emphasis>ldapsam</emphasis> - An LDAP based back-end. Permits the
	LDAP server to be specified. eg: ldap://localhost or ldap://frodo.murphy.com.
	Like the tdbsam, ldapsam permits the storing of extended account attributes
	for control of things like: Permitted access times, password activation and
	expiry, permitted points of access (workstation names), per user profile
	location, and much more.
	</para></listitem>

	<listitem><para>
	<emphasis>ldapsam_compat</emphasis> - An LDAP back-end that maintains backwards
	compatibility with the behaviour of samba-2.2.x. You should use this in the process
	of mirgrating from samba-2.2.x to samba-3 if you do not want to rebuild your LDAP
	database.
	</para></listitem>
</itemizedlist>

<para>
Read the chapter about <link linkend="passdb">Account Information Database</link> for details
regarding the choices available and how to configure them.
</para>

<note><para>
The new tdbsam and ldapsam account backends store substantially more information than
smbpasswd is capable of. The new backend database includes capacity to specify
per user settings for many parameters, over-riding global settings given in the
<filename>smb.conf</filename> file. eg: logon drive, logon home, logon path, etc.
Thus, with samba-3 it is possible to have a default system configuration for profiles,
and on a per user basis to over-ride this for those users who should not be subject
to the default configuration.
</para></note>

</sect1>

<sect1>
<title>Basics of Domain Control</title>

<para>
Over the years public perceptions of what Domain Control really is has taken on an
almost mystical nature. Before we branch into a brief overview of Domain Control
there are three basic types of domain controllers:
</para>

<sect2>
<title>Domain Controller Types</title>

<itemizedlist>
	<listitem><para>Primary Domain Controller</para></listitem>
	<listitem><para>Backup Domain Controller</para></listitem>
	<listitem><para>ADS Domain Controller</para></listitem>
</itemizedlist>

<para>
The <emphasis>Primary Domain Controller</emphasis> or PDC plays an important role in the MS 
Windows NT4 and Windows 200x Domain Control architecture, but not in the manner that so many
expect. There is folk lore that dictates that because of it's role in the MS Windows
network that the PDC should be the most powerful and most capable machine in the network.
As strange as it may seem to say this here, good over all network performance dictates that
the entire infrastructure needs to be balanced. It is advisable to invest more in the Backup
Domain Controllers and Stand-Alone (or Domain Member) servers than in the PDC.
</para>

<para>
In the case of MS Windows NT4 style domaines it is the PDC seeds the Domain Control database,
a part of the Windows registry called the SAM (Security Accounts Management). It plays a key
part in NT4 type domain user authentication and in synchronisation of the domain authentication
database with Backup Domain Controllers. 
</para>

<para>
With MS Windows 200x Server based Active Directory domains, one domain controller seeds a potential
hierachy of domain controllers, each with their own area of delegated control. The master domain
controller has the ability to override any down-stream controller, but a down-line controller has
control only over it's down-line. With Samba-3 this functionality can be implemented using an
LDAP based user and machine account back end.
</para>

<para>
New to Samba-3 is the ability to use a back-end database that holds the same type of data as
the NT4 style SAM (Security Account Manager) database (one of the registry files).
The samba-3 SAM can be specified via the smb.conf file parameter
<parameter>passwd backend</parameter> and valid options include
<emphasis>smbpasswd, tdbsam, ldapsam, nisplussam, xmlsam, mysqlsam, guest</emphasis>.
</para>

<para>
The <emphasis>Backup Domain Controller</emphasis> or BDC plays a key role in servicing network
authentication requests. The BDC is biased to answer logon requests in preference to the PDC.
On a network segment that has a BDC and a PDC the BDC will be most likely to service network
logon requests. The PDC will answer network logon requests when the BDC is too busy (high load).
A BDC can be promoted to a PDC. If the PDC is on line at the time that the BDC is promoted to
PDC the previous PDC is automatically demoted to a BDC. With Samba-3 this is NOT an automatic
operation, the PDB and BDC must be manually configured and changes need to be made likewise.
</para>

<para>
With MS Windows NT4 it is an install time decision what type of machine the server will be.
It is possible to change the promote a BDC to a PDC and vica versa only, but the only way
to convert a domain controller to a domain member server or a stand-alone server is to
reinstall it. The install time choices offered are:
</para>

<itemizedlist>
	<listitem><para><emphasis>Primary Domain Controller</emphasis> - The one that seeds the domain SAM</para></listitem>
	<listitem><para><emphasis>Backup Domain Controller</emphasis> - One that obtains a copy of the domain SAM</para></listitem>
	<listitem><para><emphasis>Domain Member Server</emphasis> - One that has NO copy of the domain SAM, rather it obtains authentication from a Domain Controller for all access controls.</para></listitem>
	<listitem><para><emphasis>Stand-Alone Server</emphasis> - One that plays NO part is SAM synchronisation, has it's own authentication database and plays no role in Domain security.</para></listitem>
</itemizedlist>

<para>
With MS Windows 2000 the configuration of domain control is done after the server has been
installed. Samba-3 is capable of acting fully as a native member of a Windows 200x server
Active Directory domain.
</para>

<para>
New to Samba-3 is the ability to function fully as an MS Windows NT4 style Domain Controller,
excluding the SAM replication components. However, please be aware that Samba-3 support the
MS Windows 200x domain control protcols also.
</para>

<para>
At this time any appearance that Samba-3 is capable of acting as an
<emphasis>ADS Domain Controller</emphasis> is limited and experimental in nature.
This functionality should not be used until the samba-team offers formal support for it.
At such a time, the documentation will be revised to duely reflect all configuration and
management requirements.
</para>

</sect2>

<sect2>
<title>Preparing for Domain Control</title>

<para>
There are two ways that MS Windows machines may interact with each other, with other servers,
and with Domain Controllers: Either as <emphasis>Stand-Alone</emphasis> systems, more commonly
called <emphasis>Workgroup</emphasis> members, or as full participants in a security system,
more commonly called <emphasis>Domain</emphasis> members.
</para>

<para>
It should be noted that <emphasis>Workgroup</emphasis> membership involve no special configuration
other than the machine being configured so that the network configuration has a commonly used name
for it's workgroup entry. It is not uncommon for the name WORKGROUP to be used for this. With this
mode of configuration there are NO machine trust accounts and any concept of membership as such
is limited to the fact that all machines appear in the network neighbourhood to be logically
groupped together. Again, just to be clear: <strong>workgroup mode does not involve any security machine 
accounts</strong>.
</para>

<para>
Domain member machines have a machine account in the Domain accounts database. A special procedure
must be followed on each machine to affect Domain membership. This procedure, which can be done
only by the local machine Administrator account, will create the Domain machine account (if
if does not exist), and then initializes that account. When the client first logs onto the
Domain it triggers a machine password change.
</para>

<note><para>
When running a Domain all MS Windows NT / 200x / XP Professional clients should be configured
as full Domain Members - IF A SECURE NETWORK IS WANTED. If the machine is NOT made a member of the
Domain, then it will operate like a workgroup (stand-alone) machine. Please refer to the chapter
on Domain Membership for information regarding HOW to make your MS Windows clients Domain members.
</para></note>

<para>
The following are necessary for configuring Samba-3 as an MS Windows NT4 style PDC for MS Windows
NT4 / 200x / XP clients.
</para>

<simplelist>
	<member>Configuration of basic TCP/IP and MS Windows Networking</member>
	<member>Correct designation of the Server Role (<parameter>security = user</parameter>)</member>
	<member>Consistent configuration of Name Resolution (See <link linkend="NetworkBrowsing">chapter on Browsing</link> and on
	<link linkend="integrate-ms-networks">MS Windows network Integration</link>)</member>
	<member>Domain logons for Windows NT4 / 200x / XP Professional clients</member>
	<member>Configuration of Roaming Profiles or explicit configuration to force local profile usage</member>
	<member>Configuration of Network/System Policies</member>
	<member>Adding and managing domain user accounts</member>
	<member>Configuring MS Windows client machines to become domain members</member>
</simplelist>

<para>
The following provisions are required to serve MS Windows 9x / Me Clients:
</para>

<simplelist>
	<member>Configuration of basic TCP/IP and MS Windows Networking</member>
	<member>Correct designation of the Server Role (<parameter>security = user</parameter>)</member>
	<member>Network Logon Configuration (Since Windows 9x / XP Home are not technically domain
	members, they do not really particpate in  the security aspects of Domain logons as such)</member>
	<member>Roaming Profile Configuration</member>
	<member>Configuration of System Policy handling</member>
	<member>Installation of the Network driver "Client for MS Windows Networks" and configuration
	to log onto the domain</member>
	<member>Placing Windows 9x / Me clients in user level security - if it is desired to allow
	all client share access to be controlled according to domain user / group identities.</member>
	<member>Adding and managing domain user accounts</member>
</simplelist>

<note><para>
Roaming Profiles and System/Network policies are advanced network administration topics
that are covered separately in this document.  However, these are not necessarily specific
to a Samba PDC as much as they are related to Windows NT networking concepts.
</para></note>

<para>
A Domain Controller is an SMB/CIFS server that:
</para>

<itemizedlist>
	<listitem><para>
	Advertises and registers itself as a Domain Controller (Through NetBIOS broadcasts
	as well as by way of name registrations either by Mailslot Broadcasts over UDP broadcast,
	to a WINS server over UDP unicast, or via DNS and Active Directory)
	</para></listitem>

	<listitem><para>
	Provides the NETLOGON service (actually a collection of services that runs over
	a number of protocols. These include the LanMan Logon service, the Netlogon service,
	the Local Security Account service, and variations of them)
	</para></listitem>

	<listitem><para>
	Provides a share called NETLOGON
	</para></listitem>
</itemizedlist>

<para>
For samba to provide these is rather easy to configure. Each Samba Domain Controller must provide
the NETLOGON service which samba calls the <emphasis>domain logons</emphasis> functionality
(after the name of the parameter in the &smb.conf; file). Additionally, one (1) server in a Samba-3
Domain must advertise itself as the domain master browser. This causes the Primary Domain Controller
to claim domain specific NetBIOS name that identifies it as a domain master browser for its given
domain/workgroup. Local master browsers in the same domain/workgroup on broadcast-isolated subnets
then ask for a complete copy of the browse list for the whole wide area network. Browser clients
will then contact their local master browser, and will receive the domain-wide browse list,
instead of just the list for their broadcast-isolated subnet.
</para>

</sect2>
</sect1>

<sect1>
<title>Domain Control - Example Configuration</title>

<para>
The first step in creating a working Samba PDC is to understand the parameters necessary
in &smb.conf;. Here we attempt to explain the parameters that are covered in
the &smb.conf; man page.
</para>

<para>
Here is an example &smb.conf; for acting as a PDC:
</para>

<para><programlisting>
	[global]
	    ; Basic server settings
	    <ulink url="smb.conf.5.html#NETBIOSNAME">netbios name</ulink> = <replaceable>POGO</replaceable>
	    <ulink url="smb.conf.5.html#WORKGROUP">workgroup</ulink> = <replaceable>NARNIA</replaceable>

	    ; User and Machine Account Backends
	    ; Choices are: tdbsam, smbpasswd, ldapsam, mysqlsam, xmlsam, guest
	    <ulink url="smb.conf.5.html#PASSDBBACKEND">passdb backend</ulink> = ldapsam, guest

	    ; we should act as the domain and local master browser
	    <ulink url="smb.conf.5.html#OSLEVEL">os level</ulink> = 64
	    <ulink url="smb.conf.5.html#PERFERREDMASTER">preferred master</ulink> = yes
	    <ulink url="smb.conf.5.html#DOMAINMASTER">domain master</ulink> = yes
	    <ulink url="smb.conf.5.html#LOCALMASTER">local master</ulink> = yes
	    
	    ; security settings (must user security = user)
	    <ulink url="smb.conf.5.html#SECURITYEQUALSUSER">security</ulink> = user
	    
	    ; encrypted passwords are a requirement for a PDC (default = Yes)
	    <ulink url="smb.conf.5.html#ENCRYPTPASSWORDS">encrypt passwords</ulink> = yes
	    
	    ; support domain logons
	    <ulink url="smb.conf.5.html#DOMAINLOGONS">domain logons</ulink> = yes
	    
	    ; where to store user profiles?
	    <ulink url="smb.conf.5.html#LOGONPATH">logon path</ulink> = \\%N\profiles\%u
	    
	    ; where is a user's home directory and where should it be mounted at?
	    <ulink url="smb.conf.5.html#LOGONDRIVE">logon drive</ulink> = H:
	    <ulink url="smb.conf.5.html#LOGONHOME">logon home</ulink> = \\homeserver\%u\winprofile
	    
	    ; specify a generic logon script for all users
	    ; this is a relative **DOS** path to the [netlogon] share
	    <ulink url="smb.conf.5.html#LOGONSCRIPT">logon script</ulink> = logon.cmd

	; necessary share for domain controller
	[netlogon]
	    <ulink url="smb.conf.5.html#PATH">path</ulink> = /usr/local/samba/lib/netlogon
	    <ulink url="smb.conf.5.html#READONLY">read only</ulink> = yes
	    <ulink url="smb.conf.5.html#WRITELIST">write list</ulink> = <replaceable>ntadmin</replaceable>
	    
	; share for storing user profiles
	[profiles]
	    <ulink url="smb.conf.5.html#PATH">path</ulink> = /export/smb/ntprofile
	    <ulink url="smb.conf.5.html#READONLY">read only</ulink> = no
	    <ulink url="smb.conf.5.html#CREATEMASK">create mask</ulink> = 0600
	    <ulink url="smb.conf.5.html#DIRECTORYMASK">directory mask</ulink> = 0700
</programlisting></para>

<note><para>
The above parameters make for a full set of parameters that may define the server's mode
of operation. The following parameters are the essentials alone:

<programlisting>
	workgroup = NARNIA
	domain logons = Yes
	domain master = Yes
	security = User
</programlisting>

The additional parameters shown in the longer listing above just makes for a
more complete environment.
</para></note>

<para>
There are a couple of points to emphasize in the above configuration.
</para>

<itemizedlist>
	<listitem><para>
	Encrypted passwords must be enabled.  For more details on how 
	to do this, refer to <link linkend="passdb">Account Information Database chapter</link>.
	</para></listitem>
	
	<listitem><para>
	The server must support domain logons and have a
	<parameter>[netlogon]</parameter> share
	</para></listitem>
	
	<listitem><para>
	The server must be the domain master browser in order for Windows 
	client to locate the server as a DC.  Please refer to the various 
	Network Browsing documentation included with this distribution for 
	details.
	</para></listitem>
</itemizedlist>    

</sect1>

<sect1>
<title>Samba ADS Domain Control</title>

<para>
Samba-3 is not and can not act as an Active Directory Server. It can not truely function as
an Active Directory Primary Domain Controller. The protocols for some of the functionality
the Active Directory Domain Controllers is have been partially implemented on an experiemental
only basis. Please do NOT expect Samba-3 to support these protocols - nor should you depend
on any such functionality either now or in the future. The Samba-Team may well remove such
experiemental features or may change their behaviour.
</para>

</sect1>

<sect1>
<title>Domain and Network Logon Configuration</title>

<para>
The subject of Network or Domain Logons is discussed here because it rightly forms
an integral part of the essential functionality that is provided by a Domain Controller.
</para>

<sect2>
<title>Domain Network Logon Service</title>

<para>
All Domain Controllers must run the netlogon service (<emphasis>domain logons</emphasis>
in Samba. One Domain Controller must be configured with <parameter>domain master = Yes</parameter>
(the Primary Domain Controller), on ALL Backup Domain Controllers <parameter>domain master = No</parameter>
must be set.
</para>

<sect3>
<title>Example Configuration</title>

<programlisting>
	[globals]
		domain logons = Yes
		domain master = (Yes on PDC, No on BDCs)

	[netlogon]
	        comment = Network Logon Service
		path = /var/lib/samba/netlogon
		guest ok = Yes
		browseable = No
</programlisting>

</sect3>
<sect3>
<title>The Special Case of MS Windows XP Home Edition</title>

<note><para>
MS Windows XP Home Edition does not have the ability to join any type of Domain
security facility. Unlike, MS Windows 9x / Me, MS Windows XP Home Edition also completely
lacks the ability to log onto a network.
</para></note>

<para>
To be completely clear: If you want MS Windows XP Home Edition to integrate with your
MS Windows NT4 or Active Directory Domain security understand - IT CAN NOT BE DONE.
Your only choice is to buy the upgrade pack from MS Windows XP Home Edition to
MS Windows XP Professional.
</para>

<para>
Now that this has been said, please do NOT ask the mailing list, or email any of the
Samba-Team members with your questions asking how to make this work. It can't be done.
</para>

</sect3>

<sect3>
<title>The Special Case of Windows 9x / Me</title>

<para>
A domain and a workgroup are exactly the same thing in terms of network
browsing.  The difference is that a distributable authentication
database is associated with a domain, for secure login access to a
network.  Also, different access rights can be granted to users if they
successfully authenticate against a domain logon server. Samba-3 does this
now in the same way that MS Windows NT/2K.
</para>

<para>
The SMB client logging on to a domain has an expectation that every other
server in the domain should accept the same authentication information.
Network browsing functionality of domains and workgroups is identical and
is explained in this documentation under the browsing discussions.
It should be noted, that browsing is totally orthogonal to logon support.
</para>

<para>
Issues related to the single-logon network model are discussed in this
section.  Samba supports domain logons, network logon scripts, and user
profiles for MS Windows for workgroups and MS Windows 9X/ME clients
which are the focus of this section.
</para>

<para>
When an SMB client in a domain wishes to logon it broadcast requests for a
logon server.  The first one to reply gets the job, and validates its
password using whatever mechanism the Samba administrator has installed.
It is possible (but very stupid) to create a domain where the user
database is not shared between servers, i.e. they are effectively workgroup
servers advertising themselves as participating in a domain.  This
demonstrates how authentication is quite different from but closely
involved with domains.
</para>

<para>
Using these features you can make your clients verify their logon via
the Samba server; make clients run a batch file when they logon to
the network and download their preferences, desktop and start menu.
</para>

<para><emphasis>
MS Windows XP Home edition is NOT able to join a domain and does not permit
the use of domain logons.
</emphasis></para>

<para>
Before launching into the configuration instructions, it is 
worthwhile to look at how a Windows 9x/ME client performs a logon:
</para>

<orderedlist>
<listitem>
	<para>
	The client broadcasts (to the IP broadcast address of the subnet it is in)
	a NetLogon request. This is sent to the NetBIOS name DOMAIN&lt;#1c&gt; at the
	NetBIOS layer.  The client chooses the first response it receives, which
	contains the NetBIOS name of the logon server to use in the format of 
	<filename>\\SERVER</filename>.
	</para>
</listitem>

<listitem>
	<para>
	The client then connects to that server, logs on (does an SMBsessetupX) and
	then connects to the IPC$ share (using an SMBtconX).
	</para>
</listitem>

<listitem>
	<para>
	The client then does a NetWkstaUserLogon request, which retrieves the name
	of the user's logon script. 
	</para>
</listitem>

<listitem>
	<para>
	The client then connects to the NetLogon share and searches for this 	
	and if it is found and can be read, is retrieved and executed by the client.
	After this, the client disconnects from the NetLogon share.
	</para>
</listitem>

<listitem>
	<para>
	The client then sends a NetUserGetInfo request to the server, to retrieve
	the user's home share, which is used to search for profiles. Since the
	response to the NetUserGetInfo request does not contain much more then	
	the user's home share, profiles for Win9X clients MUST reside in the user
	home directory.
	</para>
</listitem>

<listitem>
	<para>
	The client then connects to the user's home share and searches for the 
	user's profile. As it turns out, you can specify the user's home share as
	a sharename and path. For example, <filename>\\server\fred\.winprofile</filename>.
	If the profiles are found, they are implemented.
	</para>
</listitem>

<listitem>
	<para>
	The client then disconnects from the user's home share, and reconnects to
	the NetLogon share and looks for <filename>CONFIG.POL</filename>, the policies file. If this is
	found, it is read and implemented.
	</para>
</listitem>
</orderedlist>

<para>
The main difference between a PDC and a Windows 9x logon server configuration is that
</para>

<itemizedlist>
<listitem><para>
	Password encryption is not required for a Windows 9x logon server. But note
	that beginning with MS Windows 98 the default setting is that plain-text
	password support has been disabled. It can be re-enabled with the registry
	changes that are documented in the chapter on Policies.
	</para></listitem>

	<listitem><para>
	Windows 9x/ME clients do not require and do not use machine trust accounts.
	</para></listitem>
</itemizedlist>

<para>
A Samba PDC will act as a Windows 9x logon server, after all it does provide the
network logon services that MS Windows 9x / Me expect to find.
</para>

</sect3>
</sect2>

<sect2>
<title>Security Mode and Master Browsers</title>

<para>
There are a few comments to make in order to tie up some 
loose ends.  There has been much debate over the issue of whether
or not it is ok to configure Samba as a Domain Controller in security
modes other than <constant>USER</constant>.  The only security mode 
which  will not work due to technical reasons is <constant>SHARE</constant>
mode security.  <constant>DOMAIN</constant> and <constant>SERVER</constant>
mode security are really just a variation on SMB user level security.
</para>

<para>
Actually, this issue is also closely tied to the debate on whether 
or not Samba must be the domain master browser for its workgroup
when operating as a DC.  While it may technically be possible
to configure a server as such (after all, browsing and domain logons
are two distinctly different functions), it is not a good idea to do
so.  You should remember that the DC must register the DOMAIN&lt;#1b&gt; NetBIOS 
name.  This is the name used by Windows clients to locate the DC.
Windows clients do not distinguish between the DC and the DMB.
For this reason, it is very wise to configure the Samba DC as the DMB.
</para>

<para>
Now back to the issue of configuring a Samba DC to use a mode other
than <parameter>security = user</parameter>.  If a Samba host is configured to use 
another SMB server or DC in order to validate user connection 
requests, then it is a fact that some other machine on the network 
(the <parameter>password server</parameter>) knows more about the user than the Samba host.
99% of the time, this other host is a domain controller.  Now 
in order to operate in domain mode security, the <parameter>workgroup</parameter> parameter
must be set to the name of the Windows NT domain (which already 
has a domain controller). If the domain does NOT already have a Domain Controller
then you do not yet have a Domain!
</para>

<para>
Configuring a Samba box as a DC for a domain that already by definition has a
PDC is asking for trouble. Therefore, you should always configure the Samba DC
to be the DMB for its domain and set <parameter>security = user</parameter>.
This is the only officially supported mode of operation.
</para>

</sect2>

</sect1>

<sect1>
<title>Common Problems and Errors</title>

<sect2>
<title>I cannot include a '$' in a machine name</title>
<para>
A 'machine name' in (typically) <filename>/etc/passwd</filename> 	
of the machine name with a '$' appended. FreeBSD (and other BSD 
systems?) won't create a user with a '$' in their name.
</para>

<para>
The problem is only in the program used to make the entry. Once made, it works perfectly.
Create a user without the '$' using <command>vipw</command> to edit the entry, adding
the '$'. Or create the whole entry with vipw if you like, make sure you use a unique User ID!
</para>
</sect2>

<sect2>
<title>I get told "You already have a connection to the Domain...." 
or "Cannot join domain, the credentials supplied conflict with an 
existing set.." when creating a machine trust account.</title>

<para>
This happens if you try to create a machine trust account from the 
machine itself and already have a connection (e.g. mapped drive) 
to a share (or IPC$) on the Samba PDC.  The following command
will remove all network drive connections:
</para>

<screen>
	<prompt>C:\WINNT\></prompt> <userinput>net use * /d</userinput>
</screen>

<para>
Further, if the machine is already a 'member of a workgroup' that 
is the same name as the domain you are joining (bad idea) you will 
get this message.  Change the workgroup name to something else, it 
does not matter what, reboot, and try again.
</para>
</sect2>

<sect2>
<title>The system can not log you on (C000019B)....</title>

<para>I joined the domain successfully but after upgrading 
to a newer version of the Samba code I get the message, <errorname>The system 
can not log you on (C000019B), Please try again or consult your 
system administrator</errorname> when attempting to logon.
</para>

<para>
This occurs when the domain SID stored in the secrets.tdb database
is changed. The most common cause of a change in domain SID is when
the domain name and/or the server name (netbios name) is changed.
The only way to correct the problem is to restore the original domain 
SID or remove the domain client from the domain and rejoin. The domain
SID may be reset using either the net or rpcclient utilities.
</para>

<para>
The reset or change the domain SID you can use the net command as follows:

<screen>
<prompt>$ </prompt><userinput>net getlocalsid 'OLDNAME'</userinput>
<prompt>$ </prompt><userinput>net setlocalsid 'SID'</userinput>
</screen>
</para>

</sect2>

<sect2>
<title>The machine trust account for this computer either does not 
exist or is not accessible.</title>

<para>
When I try to join the domain I get the message <errorname>The machine account 
for this computer either does not exist or is not accessible</errorname>. What's 
wrong?
</para>

<para>
This problem is caused by the PDC not having a suitable machine trust account. 
If you are using the <parameter>add machine script</parameter> method to create 
accounts then this would indicate that it has not worked. Ensure the domain 
admin user system is working.
</para>

<para>
Alternatively if you are creating account entries manually then they 
have not been created correctly. Make sure that you have the entry 
correct for the machine trust account in smbpasswd file on the Samba PDC. 
If you added the account using an editor rather than using the smbpasswd 
utility, make sure that the account name is the machine NetBIOS name 
with a '$' appended to it ( i.e. computer_name$ ). There must be an entry 
in both /etc/passwd and the smbpasswd file. Some people have reported 
that inconsistent subnet masks between the Samba server and the NT 
client have caused this problem.   Make sure that these are consistent 
for both client and server.
</para>
</sect2>

<sect2>
<title>When I attempt to login to a Samba Domain from a NT4/W2K workstation,
I get a message about my account being disabled.</title>

<para>
Enable the user accounts with <userinput>smbpasswd -e <replaceable>username</replaceable>
</userinput>, this is normally done, as an account is created.
</para>

</sect2>
</sect1>
</chapter>
