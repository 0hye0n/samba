#!/usr/bin/python

import optparse
import os
import re

parser = optparse.OptionParser("source_dir")

(opts, args) = parser.parse_args()

invar = 0

if len(args) == 1:
    topdir = args[0]
else:
    topdir = "."

progs = []

f = open(os.path.join(topdir, "Makefile.in"), "r")

for l in f.readlines():
    l = l.strip()
    if invar:
        invar = (l[-1] == "\\")
        progs.extend(l.rstrip("\\").split(" "))
    else:
        m = re.match("^([^ ]*)_PROGS([0-9]*) = (.*?)([\\\\])$", l)
        if m:
            progs.extend(m.group(3).split(" "))
            invar = (m.group(4) == "\\")
        else:
            invar = False

#$progs =~ s/@([^@]+)@//g;
#$progs =~ s/\$\(.*?\)//g;

for prog in progs:
    prog = prog.strip()
    if prog == "":
        continue
    if prog[0] in ("@", "$"):
        continue
    prog = prog[len("bin/"):]

    found = False

    for i in range(9):
        p = "manpages/%s.%d.xml" % (prog, i)
        if os.path.exists(p):
            found = True

    if not found:
        print "'%s' does not have a manpage" % prog
