#!/usr/bin/make -f
# By Jelmer Vernooij <jelmer@samba.org>
# Made with the aid of debmake, by Christoph Lameter,
# based on the sample debian/rules file for GNU hello by Ian Jackson.

SOURCEPATH=../source

package=samba4

configure:
	dh_testdir
	cd $(SOURCEPATH) && ./autogen.sh
	cd $(SOURCEPATH) && ./configure --with-fhs \
		--prefix=/usr \
		--mandir=/usr/share/man \
		--enable-shared \
		--enable-static \
		--sysconfdir=/etc \
		--libdir=/etc/samba4 \
		--with-privatedir=/etc/samba4 \
		--with-piddir=/var/run/samba4 \
		--localstatedir=/var \
		--with-pam \
		--with-syslog \
		--with-readline \
		--with-ldap 
	cd $(SOURCEPATH)/build/pidl && perl Makefile.PL PREFIX=/usr
	touch $@

build: configure
	dh_testdir
	$(MAKE) -C $(SOURCEPATH) proto 
	-$(MAKE) -C $(SOURCEPATH) pch
	$(MAKE) -C $(SOURCEPATH) all
	$(MAKE) -C $(SOURCEPATH)/build/pidl all
	touch $@

clean:
	dh_testdir
	dh_clean
	rm -f build configure
	-$(MAKE) -C $(SOURCEPATH) clean

binary-indep: build install
	dh_testdir -i
	dh_testroot -i
	dh_install -i --sourcedir=debian/tmp
	dh_installdocs -i
	dh_installchangelogs -i
	dh_compress -i
	dh_fixperms -i
	dh_python -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i
# There are no architecture-independent files to be uploaded
# generated by this package.  If there were any they would be
# made here.

install: build
	dh_clean -k
	dh_installdirs
	$(MAKE) -C $(SOURCEPATH) install DESTDIR=$(CURDIR)/debian/tmp
	$(MAKE) -C $(SOURCEPATH) manpages installman DESTDIR=$(CURDIR)/debian/tmp
	mkdir -p $(CURDIR)/debian/tmp/etc/samba4
	cp $(CURDIR)/debian/smb.conf $(CURDIR)/debian/tmp/etc/samba4
	$(MAKE) -C $(SOURCEPATH)/build/pidl install DESTDIR=$(CURDIR)/debian/tmp

binary-arch: build install
	dh_testdir -a
	dh_testroot -a
	dh_install -a --sourcedir=debian/tmp
	dh_installchangelogs -a
	dh_installdocs -a
	dh_strip -a
	dh_python -a
	dh_compress -a
	dh_fixperms -a
	dh_makeshlibs -a
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-arch binary-indep 

.PHONY: binary binary-arch binary-indep clean
