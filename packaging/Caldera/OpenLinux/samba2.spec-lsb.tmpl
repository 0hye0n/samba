%define Version 	PVERSION
%define date            PRELEASE
%define Vendor  	Caldera
%define Dist		OpenLinux
%define EtcSamba 	/etc/samba.d

Name        	: samba
Version     	: %{Version}
Release     	: %{date}
Group       	: Server/Network

Summary         : Samba SMB client and server.
Summary(de)     : Ein SBM Client und Server.
Summary(es)     : Cliente y servidor SMB .
Summary(fr)     : Client et serveur SMB.
Summary(it)     : Client e server SMB.
Summary(pt)     : Um cliente e servidor de SMB.

Copyright       : Andrew Tridgell, John H Terpstra; GPL Version 2
Packager        : Klaus Singvogel <klaus@caldera.de>
Icon            : Caldera-daemon.gif
URL             : http://samba.org/samba

Requires    	: libpam >= 0.66, SysVinit-scripts >= 1.04-6


BuildRoot   	: /tmp/%{Name}-%{Version}

Source: ftp://ftp.samba.org/pub/samba/%{Name}-%{Version}%{date}.tar.gz
Patch0: %{Name}-%{Version}-smbmount.patch
Patch1: %{Name}-%{Version}-install.patch
#Patch2: %{Name}-%{Version}-smbconf.patch


%Package doc
Group       	: Server/Network

Summary         : Documentation on SAMBA.
Summary(de)     : Die Samba Dokumentation.
Summary(es)     : Documentation de Samba.
Summary(fr)     : Documentation pour Samba.
Summary(it)     : Documentazione su Samba.
Summary(pt)     : Documentação sobre o Samba.


%Package -n smbfs
Group       	: System/Network

Summary     	: Mount and unmount commands for SMB filesystems (smbfs).
Summary(de)     : SMB Dateisystem mounten und umounten.
Summary(es)     : Comandos de montaje y desmontaje de sistemas de fichero SMB (smbfs).
Summary(fr)     : Commandes pour le montage et le démontage des systèmes de fichiers SMB (smbfs).
Summary(it)     : Comandi per montare e smontare i file system SMB (smbfs).
Summary(pt)     : Os comandos mount e unmount para o sistema de ficheiros SMB (smbfs).



%Package -n swat
Group       	: Administration/Network
Requires        : setup >= 2.0-2, tcp_wrappers, netkit-base >= 0.17-5

Summary         : Samba Web Administration Tool.
Summary(de)     : Das Samba Web Administration Tool.
Summary(es)     : Utilidad de administración Samba.
Summary(fr)     : Outil d'administration Internet pour Samba.
Summary(it)     : Strumento per l'amministrazione di Samba via Web.
Summary(pt)     : A ferramenta Web de administração de Samba (Samba Web Administration Tool).



%Description

Samba provides an SMB server which can be used to provide
network services to SMB (sometimes called "Lan Manager")
clients, including various versions of MS Windows, OS/2,
and other Linux machines. Samba also provides some SMB
clients, which complement the built-in SMB filesystem
in Linux. Samba uses NetBIOS over TCP/IP (NetBT) protocols
and does NOT need NetBEUI (Microsoft Raw NetBIOS frame)
protocol.

Samba-2.2 features working NT Domain Control capability and 
includes the SWAT (Samba Web Administration Tool) that 
allows samba's smb.conf file to be remotely managed using your 
favourite web browser. For the time being this is being
enabled on TCP port 901 via inetd.

Users are advised to use Samba-2.2 as a Windows NT4
Domain Controller only on networks that do NOT have a Windows
NT Domain Controller. This release does NOT as yet have
Backup Domain control ability.

Please refer to the WHATSNEW.txt document for fixup information.
This binary release includes encrypted password support.

Please read the smb.conf file and ENCRYPTION.txt in the
docs directory for implementation details.

NOTE: Caldera OpenLinux uses PAM which has integrated support
for Shadow passwordsand for quotas. Do NOT recompile with the 
SHADOW_PWD option enabled.

%Description -l de
Samba bietet einen SMB Server der benutzt werden kann um Netzwerkdienste
verschiedenen SMB Clients (manchmal "LAN Manager" genannat) inklusive MS
Windows und OS/2 aunzubieten. Es biete auch einige SMB Clients. Diese
Version bietet eine fast vollständig arbeitende NT Domain Kontrolle und
beinhaltet das neue Samba Web Administration Tool (SWAT).

%Description -l es
Samba dispone de un servidor SMB que puede utilizarse para disponer de
servicios de red a clientes SMB, incluyendo varias versiones de MS Windows y
OS/2. También ofrece algunos clientes SMB. Esta versión incluye la capacidad
de Control de Dominios de NT casi funcional y también incluye la nueva
Herramienta Administrativa por Web de Samba (SWAT)
%Description -l fr
Samba fournit un serveur SMB qui peut être utilisé pour mettre en place un
service de réseau vers des clients SMB (parfois appelé "LAN Manager"),
comportant diverses version s de MS Windows et d'OS/2. Il prévoit également
quelques clients MB. Cette version présente une fonction de contrôle de
domaine sous NT presque fonctionnelle et intègre le nouveau programme SWAT
(Samba Web Administration Tool).

%Description -l it
Samba fornisce un SMB server che può essere utilzzato per fornire servizi di 
rete a client SMB (chiamati anche "LAN Manager") tra cui varie versioni
di MS Windows e OS/2. Questo pacchetto fornisce anche alcuni client SMB.
Questa versione contiene quasi tutte le funzionalità del NT Domain Control
e include anche il nuovo  Samba Web Administration Tool (SWAT).

%Description -l pt
O Samba fornece um servidor de SMB que pode ser usado para providenciar 
serviços de rede aos clientes de SMB (denominado por vezes como "Lan Manager"),
incluindo várias versões do Windows e do OS/2. Fornece também alguns clientes
de SMB. Esta versão contém uma capacidade quase funcional de Controlo de
Domínios NT e inclui o SWAT (Samba Web Administration Tool), uma ferramenta de
configuração do Samba através da Web.


%Description doc
This package contains extensive SAMBA documentation, including a FAQ,
comprehensive usage documentation, and a number of examples.

%Description -l de doc
Dieses Paket beinhaltet eine ausführliche SAMBA Dokumentation, inklusive
einer FAQ, umfassender Gebrauchsdokumentation und einer Reihe von
Beispielen.

%Description -l es doc
Este paquete contiene una extensa documentación sobre SAMBA, incluyendo
FAQ (Preguntas de Uso Frecuente), documentación sobre el uso y algunos
ejemplos.

%Description -l fr doc
Ce paquetage contient une documentation complète sur SAMBA, y compris une FAQ
détaillée de son utilisation et un certain nombre d'exemples.

%Description -l it doc
Questo pacchetto contiene la documentazione su SAMBA tra cui una FAQ
una esaustiva documentazione d'uso e un certo numero di esempi.

%Description -l pt doc
Este pacote contém alguma documentação extensa sobre o SAMBA, incluindo a FAQ,
alguma documentação compreensiva sobre a utilização e alguns exemplos.


%Description -n smbfs
This package includes the tools necessary to mount filesystems from
SMB servers.

Smbmount and smbumount are an interface to the SMB filesystem. Smbfs is
a filesystem which understands the SMB protocol. This is the protocol
Windows for Workgroups, Windows NT or Lan Manager use to talk to each
other. It was inspired by samba, the program by Andrew Tridgell that
turns any unix site into a file server for DOS or Windows clients. See
http://samba.org/samba for this interesting program suite and lots of
more information on SMB and NetBIOS over TCP/IP. There you also find
explanation for conceps like NetBIOS name or share.

%Description -l de -n smbfs
Dieses Paket beinhaltet Tools zum Arbeiten mit smbfs, dem SMB Dateisystem.
SMB ist das Protokoll welches Window for Workgroups, Windows NT und LAN
Manager benutzen um sich miteinander zu verständigen. smbfs wurde von Samba
inspiriert welches einen Linux oder UNIX Rechner in einen Dateiserver für
DOS oder Windows Clients verwandelt.

%Description -l es -n smbfs
Este paquete contiene las herramientas para trabajar con smbfs, el sistema
de ficheros SMB. SMB es el protocolo que Windows para Trabajo en Grupo,
Windows NT y LAN Manager utilizan para comunicarse entre ellos. smbfs fue
inspirado por Samba, que convierte un Linux o UNIX en un servidor de ficheros
para clientes DOS o Windows.

%Description -l fr -n smbfs
Ce paquetage contient des outils pour travailler avec smbfs, le système de
fichiers SMB. Il s'agit du protocole de Windows for Workgroups, de Windows
NT, et de LAN Manager utilisé pour la discussion. Le programme smbfs est
inspiré de Samba, qui transforme un ordina teur Linux ou UNIX en serveur de
fichiers pour des clients DOS ou Windows.

%Description -l it -n smbfs
Questo pacchetto contiene strumenti per lavorare con smbfs, il filesystem
SMB. SMB è il protocollo che usano per comunicare tra loro Windows for
Workgroup, Windows NT e LAN Manager.smbfs è ispirato da Samba che rende
un computer LINUX o UNIX un server per DOS o Windows.dows clients.

%Description -l pt -n smbfs
Este pacote contém algumas ferramentas para trabalhar com o smbfs, o sistema de
ficheiros do SMB. O SMB é o protocolo que o Windows for Workgroups, Windows NT
e o Lan Manager usam para comunicar entre si. O smbfs foi inspirado no Samba,
que transforma uma máquina de UNIX ou Linux num servidor de ficheiros para os
clientes de DOS ou Windows.


%Description -n swat
swat allows a Samba administrator to configure the complex smb.conf
file via a Web browser. In addition, a swat configuration page has
help links to all the configurable options in the smb.conf file
allowing an administrator to easily look up the effects of any change.


%Description -l de -n swat
SWAT ist das Samba Web Administration Tool. Es erlaubt einem Samba
Administrator die komplexe smb.conf Datei via einem Web Browser zu
konfigurieren. SWAT beitet auch Verknüpfungen zu Hilfe-Dateien für alle
konfigurierbaren Optionen in der smb.conf Datein.

%Description -l es -n swat
SWAT es la herramienta Web de Administración Samba. Permite al administrador
SAMBA configurar el fichero smb.conf a través de un navegador. SWAT también
tiene enlaces de ayuda para todas las opciones configurables del fichero
smb.conf

%Description -l fr -n swat
SWAT (Samba Web Administration Tool) permet à un administrateur Samba de
configurer le fichier smb.conf complexe, via un navigateur Web. SWAT
contient également des liens pour toutes les options configurables dans
le fichier smb.conf.

%Description -l it -n swat
SWAT  è il Samba Web Administration tool. Permette ad un amministratore
Samba di configurare il complesso file smb.conf attraverso un browser
Web. SWAT ha anche dei link di aiuto per tutte le opzioni di configurazione
del file smb.conf.

%Description -l pt -n swat
O SWAT (Samba Web Administration Tool) é uma ferramenta de administração via 
Web do Samba. Permite a um administrador de Samba configurar o ficheiro 
complexo smb.conf através dum navegador Web. O SWAT também tem referências de
ajuda para todas as opções configuráveis no ficheiro smb.conf.


%Prep
%setup -n samba
%patch0 -p1
%patch1 -p1
#%patch2 -p1

# instead of patch (to help configuration) ...   ;^)
%{fixUP} -vbT source/Makefile.in -e '
  s:we don.t use sbindir because we want:if you want : +
  s:(the previous releases of Samba):$1, please use: +
  s:(SBINDIR\s*=\s*\@)b:# ./configure --sbindir=\\\$(BINDIR)\n${1}sb: +
  s:/log\.(\S+):/log/samba.d/${1}d: +
  s:(PASSWD_PROGRAM\s*=\s*)(/bin):$1/usr$2:
'
#  s:^(LIBS\s*=):AUTH_$1: +
#  s:((CLIENT|CUPS|NMBD|SMBD|SWAT|RPCCLIENT|SMBPASSWD|STATUS|TESTPRNS|TESTPARM)_OBJ\) )(\$\(LDF):$1\$(AUTH_LIBS) $3:

for i in {cvs.,change-}log; do [ ! -f ../$i ] || mv ../$i source; done

mv swat/help/welcome.html docs
%{fixUP} -vT docs -e '
  s:/usr/local/samba/bin/(smb(client|run)):/usr/bin/$1:g +
  s:/usr/local/samba/bin/((s|n)mbd|swat):/usr/sbin/$1:g +
  s:/usr/local/samba/var/locks:/var/lock/samba.d: +
  s:/usr/local/samba/(var|lib)/log:/var/log/samba.d/smb: +
  s:/usr/local/samba/swat:/usr/share/samba/swat:g +
  s:/usr/local/samba/lib:%{EtcSamba}:g;
'
mv docs/welcome.html swat/help
for i in docs/*/smb.conf.5*; do
  %{fixUP} -vT $i -e '
    s:users\.map:smbusers:g +
    s:SAMBA_INSTALL_DIRECTORY/lib:%{EtcSamba}: +
    s:None \(set in compile\)\.:(see above).: +
    s:/usr/local/:/usr/:g;
  '
done
%{fixUP} -vT docs/textdocs/Faxing.txt -e '
  s:/usr/local/etc/:/etc/: +
  s:/usr/local/:/usr/:;
'
%{fixUP} -vT docs/textdocs/ENCRYPTION.txt -e '
  s:/usr/local/samba/private:%{EtcSamba}:g +
  s:mksmbpasswd.sh:mksmbpasswd:g +
  s:the Samba source directory:/usr/bin:;
'
# End of DirtyHack(TM)


%Build
cd source
autoreconf

CFLAGS="$RPM_OPT_FLAGS" LDFLAGS="-s" ./configure \
	--prefix='$(DESTDIR)/usr' \
	--localstatedir='$(DESTDIR)/var' \
	--libdir='$(DESTDIR)%{EtcSamba}' \
	--with-privatedir='$(LIBDIR)' \
	--with-lockdir='$(DESTDIR)/var/lock/samba.d' \
	--with-swatdir='$(DESTDIR)/usr/share/swat' \
	--with-smbmount --with-pam --without-smbwrapper \
	--with-utmp --with-quotas --with-vfs --with-msdfs \
	--with-profile --with-syslog --with-utmp --with-netatalk \
	--with-sambabook=$(DESTDIR)/%{_defaultdocdir}/swat/using_samba

make LOGFILEBASE=/var/log/samba.d all nsswitch/libnss_wins.so


%Install
%{mkDESTDIR}
VVS=packaging/%{Vendor}/%{Dist}

mkdir -p $DESTDIR/etc/{{logrotate,pam}.d,sysconfig/daemons,skel/Public}
mkdir -p $DESTDIR/var/{lo{ck,g}/samba.d,spool/samba}
mkdir -p $DESTDIR/usr/{lib,share}
mkdir -p $DESTDIR/home/samba $DESTDIR%{EtcSamba}/codepages/src $DESTDIR/sbin
mkdir -p $DESTDIR/tmp/Public
mkdir -p $DESTDIR/%{SVIdir}

make LOGFILEBASE=/var/log/samba.d -C source  install

strip $DESTDIR/usr/bin/smb{mount,mnt,umount}
mv $DESTDIR/usr/bin/{make,add,conv}* $DESTDIR/usr/sbin

#cp -p source/codepages/codepage_def.??? $DESTDIR%{EtcSamba}/codepages/src

# Install the nsswitch library extension file
install -m 755 source/nsswitch/libnss_wins.so $DESTDIR/usr/lib/libnss_wins.so.2.0
# Make link for wins resolver
ln -s libnss_wins.so.2.0 $DESTDIR/usr/lib/libnss_wins.so.2
ln -s libnss_wins.so.2.0 $DESTDIR/usr/lib/libnss_wins.so

#lsb: cp -p $VVS/samba.init $DESTDIR/etc/rc.d/init.d/samba
ln -s /etc/rc.d/init.d/samba $DESTDIR/usr/sbin

cp -p $VVS/smb.conf.sample $DESTDIR%{EtcSamba}/smb.conf.sample
#cp -p $VVS/smb.conf.sample $DESTDIR%{EtcSamba}/smb.conf
cp -p $VVS/smbusers $DESTDIR%{EtcSamba}
cp -p $VVS/smbprint $DESTDIR/usr/bin
cp -p $VVS/smbadduser.perl $DESTDIR/usr/sbin/smbadduser
cp -p $VVS/make_smbpasswd.perl $DESTDIR/usr/sbin/make_smbpasswd
cp -p $VVS/convertsmbpasswd.perl $DESTDIR/usr/sbin/convertsmbpasswd
cp -p $VVS/updatesmbpasswd.perl $DESTDIR/usr/sbin/updatesmbpasswd
cp -p $VVS/findsmb $DESTDIR/usr/sbin
cp -p $VVS/samba.daemon $DESTDIR/etc/sysconfig/daemons/samba
cp -p $VVS/samba.pam $DESTDIR/etc/pam.d/samba
cp -p $VVS/samba.logrotate $DESTDIR/etc/logrotate.d/samba
cp -p $VVS/README.home $DESTDIR/etc/skel/Public/README.txt
cp -p $VVS/README.tmp $DESTDIR/tmp/Public/README.txt

for f in testparm testprns; do
  ln -s $f $DESTDIR/usr/bin/smb$f
  ln -s $f.1 $DESTDIR/usr/man/man1/smb$f.1
done
ln -s make_smbcodepage  $DESTDIR/usr/sbin/mksmbcodepage
ln -s make_smbpasswd $DESTDIR/usr/sbin/mksmbpasswd
ln -sf convert_smbpasswd $DESTDIR/usr/sbin/convertsmbpasswd

# startup file (for lsb)
install -m 755 %{SOURCE3} $DESTDIR/%{SVIdir}/%{Name}

cat <<-'EoH' > $DESTDIR%{EtcSamba}/lmhosts
	127.0.0.1 localhost
EoH

# lsb has new way of inetd configuration
mkdir -p $DESTDIR%{NKinetdir}
cat <<EoI >$DESTDIR%{NKinetdir}/swat
swat	stream	tcp	nowait.400 root	/usr/sbin/tcpd	swat
EoI


DOCD="$DESTDIR/%{_defaultdocdir}/samba-%{Version}"; mkdir -p $DOCD
ln -sf ../Copyrights/GPL-2.0  $DOCD/COPYING
cp -p README README-smbmount Manifest Read-Manifest-Now $DOCD
cp -p WHATSNEW.txt Roadmap $DOCD
cp -a docs examples $DOCD

mv $DOCD/docs/htmldocs/wfw_slip.htm $DOCD/docs/wfw_slip.html

rm -rf $DOCD/docs/{htmldocs,manpages,yodldocs}
rm -rf $DOCD/examples/{svr4-startup,printing}

cp -p swat/README $DOCD/README.swat

%{fixUP} -T $DESTDIR/%{SVIdir} -e 's:\@SVIdir\@:%{SVIdir}:'
%{fixUP} -vT $DOCD/examples -e 's:/usr/local/bin/:/usr/bin/:g;'

%{fixManPages}

%{mkLists} -c samba
cat << 'EOF' | %{mkLists} -d samba
Public					base
^/(etc|var|home|tmp)			config-IGNORED
swat					swat
doc/samba-[^/]+/$			base
doc/samba- 				doc
tmp					IGNORED
man					IGNORED
@default@
EOF
cat << 'EOF' | %{mkLists} -f -a samba
Public/README.txt			base
^/etc					config-IGNORED
/doc/samba-[^/]+/(COPYING|README$)	base
libnss_wins.so				base
doc/samba-[^/]+/(COPYING|README$)	base
/doc/samba- 				doc
smb(mount|mnt|umount)			smbfs
mount.smbfs				smbfs
swat					swat
@default@
EOF


%Clean
%{rmDESTDIR}


%Post
#no lsb: lisa --SysV-init install samba S91 3:4:5 K09 0:1:2:6
/usr/lib/LSB/init-install %{Name}


%Post -n swat
#no lsb: lisa --inetd install swat stream tcp nowait.400 root /usr/sbin/tcpd swat
%{NKinetdReload}
perl -pi -e '$s=1 if /^swat/;
  print "swat:ALL EXCEPT 127.0.0.1\n" if eof && ! $s' /etc/hosts.deny


%PostUn
test "$1" = "0" || exit 0
#no lsb: lisa --SysV-init remove samba $1
/usr/lib/LSB/init-remove %{Name}
# We want to remove the browse.dat and wins.dat files so they can not
# interfer with a new version of samba!
rm -f /var/lock/samba/{browse,wins}.dat 


%PostUn -n swat
#$no lsb: lisa --inetd disable swat $1
test "$1" = "0" || exit 0
%{SVIdir}/inet reload
[ -x /usr/sbin/swat ]||perl -ni -e '/^swat\s*\:/||print' /etc/hosts.deny


%Files -f files-samba-base
%defattr(-,root,root)
%config %attr(0755,root,root) %{SVIdir}/samba
%config %attr(644,root,root) /etc/sysconfig/daemons/samba
%config %attr(644,root,root) /etc/pam.d/samba
%config %attr(644,root,root) /etc/logrotate.d/samba
%config %attr(-,root,root) %{EtcSamba}
%config %attr(755,root,root) /home/samba

%dir %attr(755,root,root) /var/lock/samba.d
%dir %attr(755,root,root) /var/log/samba.d
%dir %attr(1777,root,root) /var/spool/samba
#%dir %attr(775,root,nobody) /home/samba


%Files doc -f files-samba-doc
%defattr(-,root,root)


%Files -n smbfs -f files-samba-smbfs
%defattr(-,root,root)


%Files -n swat  -f files-samba-swat
%defattr(-,root,root)
%config %attr(644,root,root) %{NKinetdir}/swat


%ChangeLog
* Mon Jan 01 1997 ...
$Id: samba2.spec-lsb.tmpl,v 1.1.2.1 2001/01/16 15:48:34 jht Exp $
