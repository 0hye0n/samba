#!/bin/bash

cat mklist.txt |
while read f; do
    echo "Processing $f"
    f="../../$f"
    test -f $f || {
	echo "$f doesn't exist"
	exit 1
    }
    ws="$(dirname $f)/wscript_build"
    if [ -f $ws ]; then
	if ! grep "AUTOGENERATED.by.mktowscript" $ws > /dev/null; then
	    echo "Skipping manually edited file $ws"
	    continue
	fi
    fi
    ./mktowscript.pl $f > wscript_build.$$ || {
	echo "Failed on $f"
	rm -f wscript_build.$$
	exit 1
    }
    if cmp wscript_build.$$ $ws > /dev/null 2>&1; then
	rm -f wscript_build.$$
    else
	mv wscript_build.$$ $ws || exit 1
    fi
    #exit 1
done
