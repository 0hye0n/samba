#! /usr/bin/env python

srcdir = '..'
blddir = 'bin'

APPNAME='samba'
VERSION='4.0.0-alpha13'

import sys, os
sys.path.insert(0, srcdir+"/buildtools/wafsamba")
import wafsamba, Options, samba_dist

samba_dist.DIST_DIRS('.')

# install in /usr/local/samba by default
Options.default_prefix = '/usr/local/samba'


def set_options(opt):
    opt.BUILTIN_DEFAULT('NONE')
    opt.BUNDLED_EXTENSION_DEFAULT('samba4')
    opt.RECURSE('../lib/replace')
    opt.RECURSE('dynconfig')
    opt.RECURSE('scripting/python')
    opt.RECURSE('lib/ldb')
    opt.RECURSE('selftest')
    opt.RECURSE('lib/tls')
    opt.RECURSE('../lib/nss_wrapper')
    opt.RECURSE('../lib/socket_wrapper')
    opt.RECURSE('../lib/uid_wrapper')
    opt.RECURSE('../pidl')

def configure(conf):
    conf.DEFINE('PACKAGE_NAME', 'samba', quote=True)
    conf.DEFINE('PACKAGE_STRING', 'samba 4', quote=True)
    conf.DEFINE('PACKAGE_TARNAME',  'samba', quote=True)
    conf.DEFINE('PACKAGE_URL', "http://www.samba.org/", quote=True)
    conf.DEFINE('PACKAGE_VERSION', "4", quote=True)
    conf.DEFINE('PACKAGE_BUGREPORT', 'http://bugzilla.samba.org/', quote=True)

    conf.DEFINE('CONFIG_H_IS_FROM_SAMBA', 1)
    conf.DEFINE('_SAMBA_BUILD_', 4, add_to_cflags=True)
    conf.DEFINE('HAVE_CONFIG_H', 1, add_to_cflags=True)

    if Options.options.developer:
        conf.ADD_CFLAGS('-DDEVELOPER -DDEBUG_PASSWORD')

    # set a lower limit on recursing in waf preprocessor
    conf.env.preprocessor_recursion_limit = 10

    conf.ADD_EXTRA_INCLUDES('#source4 #lib #source4/lib #source4/include')

    conf.RECURSE('../lib/replace')

    conf.find_program('python', var='PYTHON', mandatory=True)
    conf.find_program('perl', var='PERL', mandatory=True)

    # enable tool to build python extensions
    conf.check_tool('python')
    conf.check_python_version((2,4,2))
    conf.check_python_headers()

    conf.RECURSE('dynconfig')
    conf.RECURSE('scripting/python')
    conf.RECURSE('lib/ldb')
    conf.RECURSE('heimdal_build')
    conf.RECURSE('lib/tls')
    conf.RECURSE('ntvfs/sysdep')
    conf.RECURSE('../lib/util')
    conf.RECURSE('../lib/zlib')
    conf.RECURSE('../lib/util/charset')
    conf.RECURSE('auth')
    conf.RECURSE('../lib/nss_wrapper')
    conf.RECURSE('../nsswitch')
    conf.RECURSE('../lib/socket_wrapper')
    conf.RECURSE('../lib/uid_wrapper')
    conf.RECURSE('../lib/popt')
    conf.RECURSE('lib/smbreadline')
    conf.RECURSE('../pidl')

    # we don't want PYTHONDIR in config.h, as otherwise changing
    # --prefix causes a complete rebuild
    del(conf.env.defines['PYTHONDIR'])
    conf.SAMBA_CONFIG_H('include/config.h')


def etags(ctx):
    '''build TAGS file using etags'''
    import Utils
    source_root = os.path.dirname(Utils.g_module.root_path)
    cmd = 'etags $(find %s/.. -name "*.[ch]")' % source_root
    print "Running: %s" % cmd
    os.system(cmd)

def ctags(ctx):
    "build 'tags' file using ctags"
    import Utils
    source_root = os.path.dirname(Utils.g_module.root_path)
    cmd = 'ctags $(find %s/.. -name "*.[ch]" | grep -v "*_proto\.h")' % source_root
    print "Running: %s" % cmd
    os.system(cmd)

# putting this here enabled build in the list
# of commands in --help
def build(bld):
    '''build all targets'''
    pass


def pydoctor(ctx):
    '''build python apidocs'''
    cmd='LD_LIBRARY_PATH=bin/shared PYTHONPATH=bin/python pydoctor --project-name=Samba --project-url=http://www.samba.org --make-html --docformat=restructuredtext --add-package bin/python/samba'
    print "Running: %s" % cmd
    os.system(cmd)

def wafdocs(ctx):
    '''build wafsamba apidocs'''
    from samba_utils import recursive_dirlist
    os.system('pwd')
    list = recursive_dirlist('../buildtools/wafsamba', '.', pattern='*.py')

    cmd='LD_LIBRARY_PATH=bin/shared PYTHONPATH=bin/python pydoctor --project-name=wafsamba --project-url=http://www.samba.org --make-html --docformat=restructuredtext'
    print list
    for f in list:
        cmd += ' --add-module %s' % f
    print "Running: %s" % cmd
    os.system(cmd)


def dist():
    '''makes a tarball for distribution'''
    samba_dist.dist()

def distcheck():
    '''test that distribution tarball builds and installs'''
    import Scripting
    d = Scripting.distcheck
    d(subdir='source4')


