VERSION = '0.9.10'

srcdir = '../../..'
blddir = 'bin'

import sys
sys.path.insert(0, srcdir+"/buildtools/wafsamba")
import wafsamba

LIBTDB_DIR= srcdir + '/lib/tdb'
LIBTEVENT_DIR= srcdir + '/lib/tevent'

def set_options(opt):
    opt.recurse(LIBTDB_DIR)
    opt.recurse(LIBTEVENT_DIR)

def configure(conf):
    conf.sub_config(LIBTDB_DIR)
    conf.sub_config(LIBTEVENT_DIR)
    # where does the default LIBDIR end up? in conf.env somewhere?
    #
    conf.CONFIG_PATH('LDB_MODULESDIR', conf.SUBST_ENV_VAR('LIBDIR') + '/ldb')
    conf.SAMBA_CONFIG_H()

def build(bld):
    bld.BUILD_SUBDIR(LIBTDB_DIR)
    bld.BUILD_SUBDIR(LIBTEVENT_DIR)

    LDB_TDB_SRC = bld.SUBDIR('ldb_tdb',
                             '''ldb_tdb.c ldb_pack.c ldb_search.c ldb_index.c
                             ldb_cache.c ldb_tdb_wrap.c''')

    LDB_MAP_SRC = bld.SUBDIR('ldb_map',
                             'ldb_map.c ldb_map_inbound.c ldb_map_outbound.c')

    COMMON_SRC = bld.SUBDIR('common',
                            '''ldb.c ldb_ldif.c ldb_parse.c ldb_msg.c ldb_utf8.c
                            ldb_debug.c ldb_modules.c ldb_dn.c ldb_match.c
                            ldb_attributes.c attrib_handlers.c ldb_controls.c qsort.c''')

    MODULES_SRC = bld.SUBDIR('modules',
                             'rdn_name.c asq.c paged_results.c sort.c')

    bld.SAMBA_LIBRARY('ldb',
		      LDB_TDB_SRC + ' ' + COMMON_SRC + ' ' + MODULES_SRC,
		      deps='tdb tevent',
		      includes='include',
                      vnum=VERSION)

    LDB_TOOLS='ldbadd ldbsearch ldbdel ldbmodify ldbedit ldbrename ldbtest'
    for t in LDB_TOOLS.split():
        bld.SAMBA_BINARY(t,
                         'tools/%s.c tools/ldbutil.c tools/cmdline.c' % t,
                         deps='ldb dl popt')
